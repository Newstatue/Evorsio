name: directus-deploy

on:
  workflow_dispatch:

jobs:
  deploy-directus:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Redeploy Directus on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e

            APP_SUBDIR="${{ secrets.SERVER_APP_DIR }}"
            if [ -z "$APP_SUBDIR" ]; then
              echo "SERVER_APP_DIR is required"
              exit 1
            fi

            APP_DIR="$HOME/$APP_SUBDIR"
            cd "$APP_DIR"

            if [ ! -f ".env" ] || [ ! -f "docker-compose.yaml" ]; then
              echo "Missing .env or docker-compose.yaml in $APP_DIR"
              exit 1
            fi

            set -a
            . ./.env
            set +a

            DB_EXISTS=$(docker compose --env-file .env -f docker-compose.yaml exec -T postgres \
              psql -U "$POSTGRES_USERNAME" -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='directusdb'" | tr -d '[:space:]')

            if [ "$DB_EXISTS" != "1" ]; then
              echo "directusdb missing, creating..."
              docker compose --env-file .env -f docker-compose.yaml exec -T postgres \
                psql -U "$POSTGRES_USERNAME" -d postgres -c "CREATE DATABASE directusdb OWNER \"$POSTGRES_USERNAME\";"
            fi

            docker compose --env-file .env -f docker-compose.yaml pull directus
            docker compose --env-file .env -f docker-compose.yaml up -d --force-recreate --no-deps directus

            docker compose --env-file .env -f docker-compose.yaml ps directus
            docker compose --env-file .env -f docker-compose.yaml logs --tail=120 directus